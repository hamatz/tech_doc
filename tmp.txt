Private Sub Worksheet_Change(ByVal Target As Range)
    Dim wsInput As Worksheet
    Dim wsBudget As Worksheet
    Dim rng As Range
    Dim lastRow As Long
    Dim i As Long
    Dim item As String
    Dim amount As Double

    ' シートの指定
    Set wsInput = ThisWorkbook.Sheets("Input")
    Set wsBudget = ThisWorkbook.Sheets("Budget")

    ' 入力シートで変更があった場合
    If Not Intersect(Target, wsInput.Columns("B:D")) Is Nothing Then
        Application.EnableEvents = False
        
        ' Budgetシートを更新
        lastRow = wsBudget.Cells(wsBudget.Rows.Count, 1).End(xlUp).Row
        For Each rng In Target.Rows
            item = rng.Cells(1, 2).Value ' 項目
            amount = rng.Cells(1, 4).Value ' 金額
            
            ' Budgetシートをループして実績支出を更新
            For i = 2 To lastRow
                If wsBudget.Cells(i, 1).Value = item Then
                    wsBudget.Cells(i, 3).Value = wsBudget.Cells(i, 3).Value + amount
                    wsBudget.Cells(i, 4).Value = wsBudget.Cells(i, 2).Value - wsBudget.Cells(i, 3).Value
                    wsBudget.Cells(i, 6).Value = IIf(wsBudget.Cells(i, 2).Value = 0, 0, wsBudget.Cells(i, 3).Value / wsBudget.Cells(i, 2).Value * 100)
                    Exit For
                End If
            Next i
        Next rng
        
        Application.EnableEvents = True
    End If
End Sub
